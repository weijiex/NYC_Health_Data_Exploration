<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>NYC Health Data Exploration</title>
        <script src="https://d3js.org/d3.v4.js"></script>
        <script src="https://d3js.org/topojson.v1.min.js"></script>
        <link rel="stylesheet" href="style.css">
    </head>
  
  <body>

    <div id = "topicDropdown"></div>
    <div id= "yearDropdown"></div>
    
    <script>
    var margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;
    var lowColor = '#f9f9f9'
    var highColor = '#bc2a66'
    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");   
    d3.csv("map_small_data.csv", function(data) {
        data.forEach(function(d) {
            d.id = +d.id;
            d.number = +d.number;
            d.year = d.year;
        });
        /*
        var dataNest = d3.nest()
            .key(function(d){
              return d.topic;
            })
            .key(function(d){
              return d.year;
            })
          .entries(data)*/
        //console.log(dataNest[0].values[0].values[0].number)
        
        var dataNest = d3.nest()
              .key(function(d){
                return d.topic;
              })
            .rollup(function(leaves){
                    var year = d3.nest().key(function(d){
                      return d.year
                    })
                    .entries(leaves);
                    return {year: year};
                    })
            .entries(data)
        console.log(dataNest[0].value.year)
        // Create 1st dropdown
        var topicMenu = d3.select("#topicDropdown")
        topicMenu
        .append("select")
        .selectAll("option")
            .data(dataNest)
            .enter()
            .append("option")
            .attr("value", function(d){
                return d.key;
            })
            .text(function(d){
                return d.key;
            })
        // Create 2nd dropdown
          var yearMenu = d3.select("#yearDropdown")
          yearMenu
            .data(dataNest)
          .append("select")
          .selectAll("option")
              .data(function(d) { return d.value.year; })
              .enter()
              .append("option")
              .attr("value", function(d){
                  return d.key;
              })
              .text(function(d){
                  return d.key;
              })

        var dataArray = [];
        for (var d = 0; d < data.length; d++) {
          dataArray.push(parseFloat(data[d].number))
        }
        var minVal = d3.min(dataArray)
        var maxVal = d3.max(dataArray)
        var ramp = d3.scaleLinear().domain([minVal,maxVal]).range([lowColor,highColor])
      d3.json('UHF42.json', function(error, json) {
          console.log(json)
          //Merge the csv data and GeoJSON
          //Loop through once for each csv data value
          //if (error) throw error;
          for (var i = 0; i < data.length; i++) {
        
            //Grab state name
            var dataGeo = data[i].id;
            
            //Grab data value, and convert from string to float
            var dataValue = parseFloat(data[i].number);
            //Find the corresponding geo inside the GeoJSON
            for (var j = 0; j < json.features.length; j++) {
            
              var jsonGeo = json.features[j].properties.GEOCODE;
        
              if (dataGeo == jsonGeo) {
            
                //Copy the data value into the JSON
                json.features[j].properties.value = dataValue;
                
                //Stop looking through the JSON
                break;
                
              }
            }   
          }
          //Bind data and create one path per GeoJSON feature
            var path = d3.geoPath()
            .projection(d3.geoConicConformal()
            .parallels([33, 45])
            .rotate([96, -39])
            .fitSize([width, height], json)); 
         
            var g = svg.append("g");
            g.append('g')
                .selectAll('path')
                .data(json.features)
                .enter()
                .append('path')
                .attr('d', path)
                .style("fill", function(d) {
                        //Get data value
                        var value = d.properties.value;
                        
                        if (value) {
                          //If value exists…
                          return ramp(d.properties.value);
                        } else {
                          //If value is undefined…
                          return "#ccc";
                        }
             });
            // add a legend
            var w = 140, h = 300;

            var key = d3.select("body")
              .append("svg")
              .attr("width", w)
              .attr("height", h)
              .attr("class", "legend");

            var legend = key.append("defs")
              .append("svg:linearGradient")
              .attr("id", "gradient")
              .attr("x1", "100%")
              .attr("y1", "0%")
              .attr("x2", "100%")
              .attr("y2", "100%")
              .attr("spreadMethod", "pad");

            legend.append("stop")
              .attr("offset", "0%")
              .attr("stop-color", highColor)
              .attr("stop-opacity", 1);
              
            legend.append("stop")
              .attr("offset", "100%")
              .attr("stop-color", lowColor)
              .attr("stop-opacity", 1);

            key.append("rect")
              .attr("width", w - 100)
              .attr("height", h)
              .style("fill", "url(#gradient)")
              .attr("transform", "translate(0,10)");

            var y = d3.scaleLinear()
              .range([h, 0])
              .domain([minVal, maxVal]);

            var yAxis = d3.axisRight(y);

            key.append("g")
              .attr("class", "y axis")
              .attr("transform", "translate(41,10)")
              .call(yAxis)
        });
    })
    </script>
  </body>
  
</html>















